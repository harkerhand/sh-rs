name: ğŸ“¦ Rust Tag Release

on:
  # å½“æœ‰æ–°çš„ tag è¢«æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘æ­¤å·¥ä½œæµ
  push:
    tags:
      - 'v*' # åŒ¹é…æ‰€æœ‰ä»¥ 'v' å¼€å¤´çš„ tagï¼Œä¾‹å¦‚ v1.0.0, v2.1

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Rust ç¯å¢ƒ
        # ä½¿ç”¨ dtolnay/rust-toolchain åŠ¨ä½œå¯ä»¥è½»æ¾è®¾ç½® Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: âš™ï¸ ç¼“å­˜ Cargo ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ—ï¸ ç¼–è¯‘ Release ç‰ˆæœ¬
        # ä½¿ç”¨ --locked ç¡®ä¿ç¼–è¯‘æ—¶ä½¿ç”¨ Cargo.lock ä¸­çš„ç²¾ç¡®ä¾èµ–ç‰ˆæœ¬
        run: cargo build --release --locked

      - name: ğŸ·ï¸ è·å– Tag åç§°
        # ä» GITHUB_REF (refs/tags/v1.0.0) ä¸­æå–å®é™…çš„ tag (v1.0.0)
        id: get_tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ğŸ—œï¸ æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          BINARY_NAME="sh-rs" 
          TARGET_PATH="target/release/$BINARY_NAME"
          
          # åˆ›å»ºä¸€ä¸ªç‰¹å®šç‰ˆæœ¬çš„ç›®å½•ï¼ŒåŒ…å«å¯æ‰§è¡Œæ–‡ä»¶å’Œ README/LICENSE ç­‰
          mkdir -p ${{ steps.get_tag.outputs.TAG_NAME }}
          cp $TARGET_PATH ${{ steps.get_tag.outputs.TAG_NAME }}/
          
          # å¯é€‰ï¼šå¦‚æœéœ€è¦ï¼Œå¯ä»¥å¤åˆ¶å…¶ä»–æ–‡ä»¶
          # cp README.md ${{ steps.get_tag.outputs.TAG_NAME }}/
          
          # åˆ›å»º ZIP å‹ç¼©åŒ…
          zip -r ${{ steps.get_tag.outputs.TAG_NAME }}-linux-x64.zip ${{ steps.get_tag.outputs.TAG_NAME }}
          echo "ASSET_NAME=${{ steps.get_tag.outputs.TAG_NAME }}-linux-x64.zip" >> $GITHUB_ENV

      - name: ğŸš€ åˆ›å»º GitHub Release
        # ä½¿ç”¨ softprops/action-gh-release åŠ¨ä½œæ¥åˆ›å»ºå’Œä¸Šä¼  Release
        uses: softprops/action-gh-release@v1
        with:
          # assets å‚æ•°æŒ‡å®šè¦ä¸Šä¼ çš„æ–‡ä»¶
          files: ${{ env.ASSET_NAME }}
          # name å‚æ•°è®¾ç½® Release çš„æ ‡é¢˜ï¼Œä½¿ç”¨ tag åç§°
          name: Release ${{ steps.get_tag.outputs.TAG_NAME }}
          # body å‚æ•°å¯ä»¥è‡ªå®šä¹‰ Release çš„è¯´æ˜
          body: |
            # Release ${{ steps.get_tag.outputs.TAG_NAME }}
            
            ğŸ‰ New version is available!
            
            This release includes the compiled binary for Linux x64.